{% extends "base.html" %}

{% block title %}DianaBot - Anal칤ticas{% endblock %}

{% block header_title %}Anal칤ticas{% endblock %}

{% block content %}
<div x-data="analyticsManager()" class="space-y-6">
    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700">Per칤odo</label>
                <select x-model="selectedPeriod" @change="loadAnalytics" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="7d">칔ltimos 7 d칤as</option>
                    <option value="30d">칔ltimos 30 d칤as</option>
                    <option value="90d">칔ltimos 90 d칤as</option>
                    <option value="1y">칔ltimo a침o</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">M칠trica</label>
                <select x-model="selectedMetric" @change="updateChart" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="users">Usuarios Activos</option>
                    <option value="messages">Mensajes</option>
                    <option value="besitos">Besitos Ganados</option>
                    <option value="stories">Historias Completadas</option>
                    <option value="trivias">Trivias Respondidas</option>
                    <option value="missions">Misiones Completadas</option>
                </select>
            </div>
            <button @click="exportData" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                Exportar Datos
            </button>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">游논</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Usuarios Activos</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="metrics.activeUsers"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">游눫</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Mensajes Hoy</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="metrics.messagesToday"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">游눎</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Besitos Ganados</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="metrics.besitosEarned"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">游닀</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Historias Le칤das</dt>
                            <dd class="text-lg font-medium text-gray-900" x-text="metrics.storiesRead"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="getChartTitle()"></h3>
        <div class="h-80">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- Secondary Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- User Engagement Chart -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Engagement de Usuarios</h3>
            <div class="h-64">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>

        <!-- Content Performance Chart -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Rendimiento de Contenido</h3>
            <div class="h-64">
                <canvas id="contentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Conversion Funnel Analytics -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Anal칤ticas de Conversi칩n</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="text-sm text-blue-600 font-medium">Total Embudos</div>
                <div class="text-2xl font-bold text-blue-900" x-text="conversionAnalytics?.summary?.total_funnels || 0"></div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="text-sm text-green-600 font-medium">Embudos Activos</div>
                <div class="text-2xl font-bold text-green-900" x-text="conversionAnalytics?.summary?.active_funnels || 0"></div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <div class="text-sm text-purple-600 font-medium">Conversiones Completadas</div>
                <div class="text-2xl font-bold text-purple-900" x-text="conversionAnalytics?.summary?.completed_funnels || 0"></div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg">
                <div class="text-sm text-orange-600 font-medium">Tiempo Promedio (d칤as)</div>
                <div class="text-2xl font-bold text-orange-900" x-text="conversionAnalytics?.summary?.avg_time_to_conversion_days || 0"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Funnel Types Distribution -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-md font-medium text-gray-900 mb-3">Distribuci칩n por Tipo de Embudo</h4>
                <div class="space-y-2">
                    <template x-for="funnel in conversionAnalytics?.funnel_types || []" :key="funnel.type">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-700" x-text="funnel.type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())"></span>
                            <span class="text-sm font-medium text-gray-900" x-text="funnel.count"></span>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Stage Distribution -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-md font-medium text-gray-900 mb-3">Distribuci칩n por Etapa</h4>
                <div class="space-y-2">
                    <template x-for="stage in conversionAnalytics?.stage_distribution || []" :key="stage.stage">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-700" x-text="stage.stage.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())"></span>
                            <span class="text-sm font-medium text-gray-900" x-text="stage.count"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Conversion Rates -->
        <div class="mt-6">
            <h4 class="text-md font-medium text-gray-900 mb-3">Tasas de Conversi칩n</h4>
            <div class="space-y-3">
                <template x-for="rate in conversionAnalytics?.conversion_rates || []" :key="rate.funnel_type">
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-900" x-text="rate.funnel_type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())"></span>
                            <span class="text-sm font-bold text-green-600" x-text="`${rate.conversion_rate}%`"></span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span x-text="`Total: ${rate.total}`"></span>
                            <span x-text="`Completados: ${rate.completed}`"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Top Lists -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Top Users -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Usuarios M치s Activos</h3>
            <div class="space-y-3">
                <template x-for="(user, index) in topUsers" :key="user.id">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900" x-text="`#${index + 1}`"></span>
                            <span class="ml-2 text-sm text-gray-700" x-text="user.name"></span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="user.score"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Popular Content -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Contenido M치s Popular</h3>
            <div class="space-y-3">
                <template x-for="(content, index) in popularContent" :key="content.id">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900" x-text="`#${index + 1}`"></span>
                            <span class="ml-2 text-sm text-gray-700 truncate max-w-32" x-text="content.title"></span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="content.views"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Achievement Distribution -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Logros M치s Ganados</h3>
            <div class="space-y-3">
                <template x-for="(achievement, index) in topAchievements" :key="achievement.id">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900" x-text="`#${index + 1}`"></span>
                            <span class="ml-2 text-sm text-gray-700 truncate max-w-32" x-text="achievement.name"></span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="achievement.count"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function analyticsManager() {
    return {
        selectedPeriod: '30d',
        selectedMetric: 'users',
        metrics: {
            activeUsers: 0,
            messagesToday: 0,
            besitosEarned: 0,
            storiesRead: 0
        },
        topUsers: [],
        popularContent: [],
        topAchievements: [],
        chartData: [],
        conversionAnalytics: null,
        mainChart: null,
        engagementChart: null,
        contentChart: null,

        init() {
            this.loadAnalytics();
        },

        loadAnalytics() {
            // Load main analytics
            fetch(`/api/analytics?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    this.metrics = data.metrics || this.metrics;
                    this.topUsers = data.topUsers || [];
                    this.popularContent = data.popularContent || [];
                    this.topAchievements = data.topAchievements || [];
                    this.chartData = data.chartData || [];
                    this.updateChart();
                    this.updateSecondaryCharts();
                })
                .catch(error => console.error('Error loading analytics:', error));
            
            // Load conversion funnel analytics
            fetch('/api/analytics/conversion-funnels')
                .then(response => response.json())
                .then(data => {
                    this.conversionAnalytics = data;
                })
                .catch(error => console.error('Error loading conversion analytics:', error));
        },

        updateChart() {
            const ctx = document.getElementById('mainChart');
            if (this.mainChart) {
                this.mainChart.destroy();
            }

            const data = this.getChartData();
            this.mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: this.getMetricLabel(),
                        data: data.values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        },

        updateSecondaryCharts() {
            this.updateEngagementChart();
            this.updateContentChart();
        },

        updateEngagementChart() {
            const ctx = document.getElementById('engagementChart');
            if (this.engagementChart) {
                this.engagementChart.destroy();
            }

            this.engagementChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Muy Activos', 'Activos', 'Moderados', 'Poco Activos'],
                    datasets: [{
                        data: [15, 35, 30, 20],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(251, 191, 36)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        },

        updateContentChart() {
            const ctx = document.getElementById('contentChart');
            if (this.contentChart) {
                this.contentChart.destroy();
            }

            this.contentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Fragmentos', 'Trivias', 'Misiones', 'Items'],
                    datasets: [{
                        label: 'Interacciones',
                        data: [450, 320, 180, 90],
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgb(139, 92, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        },

        getChartData() {
            // Mock data - replace with actual API data
            const periods = {
                '7d': { labels: ['Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b', 'Dom'], values: [12, 19, 15, 25, 22, 30, 28] },
                '30d': { labels: Array.from({length: 30}, (_, i) => `D칤a ${i+1}`), values: Array.from({length: 30}, () => Math.floor(Math.random() * 50) + 10) },
                '90d': { labels: Array.from({length: 12}, (_, i) => `Sem ${i+1}`), values: Array.from({length: 12}, () => Math.floor(Math.random() * 100) + 20) },
                '1y': { labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'], values: Array.from({length: 12}, () => Math.floor(Math.random() * 200) + 50) }
            };
            return periods[this.selectedPeriod];
        },

        getMetricLabel() {
            const labels = {
                users: 'Usuarios Activos',
                messages: 'Mensajes',
                besitos: 'Besitos Ganados',
                stories: 'Historias Completadas',
                trivias: 'Trivias Respondidas',
                missions: 'Misiones Completadas'
            };
            return labels[this.selectedMetric];
        },

        getChartTitle() {
            return `${this.getMetricLabel()} - ${this.selectedPeriod === '7d' ? '칔ltimos 7 d칤as' : this.selectedPeriod === '30d' ? '칔ltimos 30 d칤as' : this.selectedPeriod === '90d' ? '칔ltimos 90 d칤as' : '칔ltimo a침o'}`;
        },

        exportData() {
            const data = {
                period: this.selectedPeriod,
                metrics: this.metrics,
                chartData: this.chartData,
                topUsers: this.topUsers,
                popularContent: this.popularContent,
                topAchievements: this.topAchievements,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `analytics_${this.selectedPeriod}_${new Date().toISOString().split('T')[0]}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
    }
}
</script>
{% endblock %}